name: CI

# Controls when the action will run.
# For githbu.com/chirag127/AuraWeather-RealTime-Forecasting-Mobile-App, this workflow runs on:
# push events to the main and develop branches
# pull request events targeting the main and develop branches
# schedule for regular runs (e.g., daily)
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Runs every day at 00:00 UTC
    - cron: '0 0 * * *'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # Build job to build and test the application
  build_and_test:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Setup Node.js environment
      # Uses 'setup-node' action to configure Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          # Npm cache is configured for speed and consistency
          # https://github.com/actions/setup-node

      # Install project dependencies using npm
      - name: Install Dependencies
        run: npm ci
        # 'npm ci' is used for cleaner installations in CI environments
        # It installs dependencies exactly as they are defined in package-lock.json

      # Lint and format code using ESLint (or a similar linter specified in package.json)
      # This step ensures code quality and consistency across the project
      - name: Lint Code
        run: npm run lint
        # Assumes a 'lint' script is defined in package.json, typically running ESLint

      # Run unit tests using Jest (or a similar test runner specified in package.json)
      # This step verifies the correctness of individual components and functions
      - name: Run Unit Tests
        run: npm run test:unit
        # Assumes a 'test:unit' script is defined in package.json

      # (Optional) Run E2E tests using a framework like Detox or Appium, if configured
      # This is a placeholder and would require specific setup for mobile E2E testing
      # - name: Run E2E Tests
      #   run: npm run test:e2e

      # Build the Expo application for release
      # This step prepares the application for distribution on iOS and Android platforms
      - name: Build Expo Application
        run: | 
          npx expo prebuild --platform android || npx expo prebuild --platform ios
          npx expo build:android --non-interactive --no-wait-for-build-success || echo "Android build failed or skipped"
          npx expo build:ios --non-interactive --no-wait-for-build-success || echo "iOS build failed or skipped"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          # Requires an Expo access token for building
          # https://docs.expo.dev/build/setup/

      # (Optional) Upload build artifacts if needed (e.g., APK, IPA files)
      # This step can be used to save the build outputs for later use or distribution
      # - name: Upload Artifacts
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: 'AuraWeather-App-Builds'
      #     path: 'dist/' # Adjust path as necessary

      # Report code coverage to Codecov
      # This requires Codecov to be configured in the repository settings
      # Assumes 'test:unit' script generates coverage reports (e.g., lcov.info)
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # necessary if CODECOV_TOKEN is set to protect your repository
          slug: chirag127/AuraWeather-RealTime-Forecasting-Mobile-App # Ensure this matches your repo slug
          # https://github.com/codecov/codecov-action

# This CI workflow provides a robust foundation for the AuraWeather mobile application,
# ensuring code quality, test coverage, and build success for every commit and pull request.
# The workflow is designed to integrate seamlessly with GitHub Actions and Expo's build services.
